<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BaZi Analysis System</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #6366f1;
            --secondary-color: #4f46e5;
            --background-color: #f8fafc;
            --card-background: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .card {
            background: var(--card-background);
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 2rem;
            margin-bottom: 2rem;
            transition: transform 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 2rem;
            text-align: center;
        }

        h2 {
            font-size: 1.8rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group {
            position: relative;
        }

        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        input, select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            color: var(--text-primary);
            background-color: var(--card-background);
            transition: all 0.2s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        button {
            background-color: var(--primary-color);
            color: white;
            padding: 0.875rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            max-width: 300px;
            display: block;
            margin: 0 auto;
        }

        button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-1px);
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .verification-code {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 2rem 0;
        }

        .verification-code input {
            width: 50px;
            height: 50px;
            text-align: center;
            font-size: 1.5rem;
        }

        .results-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 1.5rem 0;
            background: var(--card-background);
            border-radius: 12px;
            overflow: hidden;
        }

        .results-table th, .results-table td {
            padding: 1rem;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }

        .results-table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
        }

        .results-table tr:last-child td {
            border-bottom: none;
        }

        .results-table tr:hover td {
            background-color: rgba(99, 102, 241, 0.05);
        }

        .interpretation {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: rgba(99, 102, 241, 0.05);
            border-radius: 8px;
        }

        .email-input-group {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }

        .email-input-group input {
            flex: 1;
        }

        .send-code-btn {
            background-color: var(--secondary-color);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            width: auto;
            max-width: none;
            margin: 0;
        }

        .send-code-btn:disabled {
            background-color: var(--text-secondary);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .verification-section {
            margin-top: 2rem;
        }

        .verification-code {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            margin: 1rem 0;
        }

        .verification-code input {
            width: 60px;
            height: 60px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 600;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .verification-code input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .verification-hint {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-top: 1rem;
        }

        .resend-timer {
            color: var(--primary-color);
            font-weight: 500;
            margin-top: 0.5rem;
        }

        .verify-btn {
            margin-top: 2rem;
            background-color: var(--primary-color);
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }

            .card {
                padding: 1.5rem;
            }

            h1 {
                font-size: 2rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .verification-code {
                flex-wrap: wrap;
            }

            .email-input-group {
                flex-direction: column;
            }

            .send-code-btn {
                width: 100%;
            }

            .verification-code input {
                width: 50px;
                height: 50px;
                font-size: 1.25rem;
            }
        }

        .results-container {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .bazi-chart {
            background: var(--card-background);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .chart-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            max-width: 800px;
            margin: 0 auto;
        }

        .chart-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .chart-label {
            font-weight: 500;
            color: var(--text-secondary);
        }

        .chart-cell {
            width: 80px;
            height: 80px;
            position: relative;
            cursor: pointer;
            transition: transform 0.3s;
            margin: 0.5rem 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--background-color);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 2rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .chart-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .chart-hint {
            color: var(--text-secondary);
            font-size: 0.875rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        .elements-analysis {
            background: var(--card-background);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .elements-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .element-card {
            background: var(--background-color);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: transform 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .element-card:hover {
            transform: translateY(-5px);
        }

        .element-card.wood { border: 2px solid #4CAF50; }
        .element-card.fire { border: 2px solid #FF5722; }
        .element-card.earth { border: 2px solid #795548; }
        .element-card.metal { border: 2px solid #9E9E9E; }
        .element-card.water { border: 2px solid #2196F3; }

        .element-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 1;
        }

        .element-name {
            font-weight: 500;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 1;
        }

        .element-percentage {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
            position: relative;
            z-index: 1;
        }

        .element-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.1;
            transition: opacity 0.2s ease;
        }

        .element-card:hover .element-bg {
            opacity: 0.2;
        }

        .wood .element-bg { background-color: #4CAF50; }
        .fire .element-bg { background-color: #FF5722; }
        .earth .element-bg { background-color: #795548; }
        .metal .element-bg { background-color: #9E9E9E; }
        .water .element-bg { background-color: #2196F3; }

        .detailed-analysis {
            background: var(--card-background);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .analysis-card {
            background: var(--background-color);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .analysis-card h4 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .recommendations {
            background: var(--card-background);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .recommendations-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .recommendation-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            background: var(--background-color);
            border-radius: 8px;
        }

        .recommendation-icon {
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        @media (max-width: 768px) {
            .chart-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .elements-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .analysis-grid {
                grid-template-columns: 1fr;
            }
        }

        .basic-info {
            background: var(--card-background);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-top: 2rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .info-card {
            background: var(--background-color);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: transform 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .info-card:hover {
            transform: translateY(-5px);
        }

        .info-card h4 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .info-card p {
            font-size: 1.25rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .zodiac-icon {
            font-size: 2rem;
        }

        .element-info {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        /* 弹出卡片样式 */
        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .popup-overlay.active {
            display: flex;
        }

        .popup-card {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            max-width: 90%;
            width: 400px;
            position: relative;
            animation: popIn 0.3s ease-out;
        }

        @keyframes popIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .popup-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0.5rem;
            line-height: 1;
        }

        .popup-content {
            text-align: center;
        }

        .popup-character {
            font-size: 4rem;
            margin-bottom: 1rem;
            color: var(--primary-color);
        }

        .popup-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .popup-description {
            font-size: 1rem;
            line-height: 1.6;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .popup-element {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            background: var(--background-secondary);
            color: var(--primary-color);
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Step 1: Birth Information -->
        <div class="card step active" id="step1">
            <h1>BaZi Analysis System</h1>
            <form id="birthForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="birthYear">Birth Year</label>
                        <select id="birthYear" required>
                            <option value="">Select Year</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="birthMonth">Birth Month</label>
                        <select id="birthMonth" required>
                            <option value="">Select Month</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="birthDay">Birth Day</label>
                        <select id="birthDay" required>
                            <option value="">Select Day</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="birthHour">Birth Hour</label>
                        <select id="birthHour" required>
                            <option value="">Select Hour</option>
                        </select>
                    </div>
                </div>
                <button type="submit">Next: Email Verification</button>
            </form>
        </div>

        <!-- Step 2: Email Verification -->
        <div class="card step" id="step2">
            <h2>Email Verification</h2>
            <form id="emailForm">
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <div class="email-input-group">
                        <input type="email" id="email" required placeholder="Enter your email">
                        <button type="button" id="sendCodeBtn" class="send-code-btn">Send Code</button>
                    </div>
                </div>
                <div class="verification-section">
                    <label>Verification Code</label>
                    <div class="verification-code">
                        <input type="text" maxlength="1" pattern="[0-9]" required>
                        <input type="text" maxlength="1" pattern="[0-9]" required>
                        <input type="text" maxlength="1" pattern="[0-9]" required>
                        <input type="text" maxlength="1" pattern="[0-9]" required>
                    </div>
                    <div class="verification-hint">
                        <p>Please enter the 4-digit code sent to your email</p>
                        <p class="resend-timer" id="resendTimer"></p>
                    </div>
                </div>
                <button type="submit" class="verify-btn">Verify Email</button>
            </form>
        </div>

        <!-- Step 3: Results -->
        <div class="card step" id="step3">
            <h2>Your BaZi Analysis Results</h2>
            <div class="results-container">
                <!-- Basic Info Section -->
                <div class="basic-info">
                    <h3>Basic Information</h3>
                    <div class="info-grid">
                        <div class="info-card">
                            <h4>Chinese Zodiac</h4>
                            <p>
                                <span class="zodiac-icon" id="zodiacIcon"></span>
                                <span id="zodiacAnimal"></span>
                            </p>
                            <p class="element-info" id="zodiacElement"></p>
                        </div>
                        <div class="info-card">
                            <h4>Western Zodiac</h4>
                            <p>
                                <span class="zodiac-icon" id="zodiacSignIcon"></span>
                                <span id="westernZodiac"></span>
                            </p>
                            <p class="element-info" id="zodiacSignElement"></p>
                        </div>
                    </div>
                </div>

                <!-- BaZi Chart Section -->
                <div class="bazi-chart">
                    <div class="chart-header">
                        <h3>BaZi Chart</h3>
                        <p class="chart-hint">Click on cards for detailed explanation</p>
                    </div>
                    <div class="chart-grid">
                        <div class="chart-column">
                            <div class="chart-label">年柱</div>
                            <div class="chart-cell" id="yearStem"></div>
                            <div class="chart-cell" id="yearBranch"></div>
                        </div>
                        <div class="chart-column">
                            <div class="chart-label">月柱</div>
                            <div class="chart-cell" id="monthStem"></div>
                            <div class="chart-cell" id="monthBranch"></div>
                        </div>
                        <div class="chart-column">
                            <div class="chart-label">日柱</div>
                            <div class="chart-cell" id="dayStem"></div>
                            <div class="chart-cell" id="dayBranch"></div>
                        </div>
                        <div class="chart-column">
                            <div class="chart-label">时柱</div>
                            <div class="chart-cell" id="hourStem"></div>
                            <div class="chart-cell" id="hourBranch"></div>
                        </div>
                    </div>
                </div>

                <!-- Elements Analysis Section -->
                <div class="elements-analysis">
                    <h3>Five Elements Analysis</h3>
                    <div class="elements-grid">
                        <div class="element-card wood">
                            <div class="element-bg"></div>
                            <div class="element-icon">🌳</div>
                            <div class="element-name">Wood</div>
                            <div class="element-percentage" id="woodPercentage">0%</div>
                        </div>
                        <div class="element-card fire">
                            <div class="element-bg"></div>
                            <div class="element-icon">🔥</div>
                            <div class="element-name">Fire</div>
                            <div class="element-percentage" id="firePercentage">0%</div>
                        </div>
                        <div class="element-card earth">
                            <div class="element-bg"></div>
                            <div class="element-icon">🌍</div>
                            <div class="element-name">Earth</div>
                            <div class="element-percentage" id="earthPercentage">0%</div>
                        </div>
                        <div class="element-card metal">
                            <div class="element-bg"></div>
                            <div class="element-icon">⚔️</div>
                            <div class="element-name">Metal</div>
                            <div class="element-percentage" id="metalPercentage">0%</div>
                        </div>
                        <div class="element-card water">
                            <div class="element-bg"></div>
                            <div class="element-icon">💧</div>
                            <div class="element-name">Water</div>
                            <div class="element-percentage" id="waterPercentage">0%</div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Analysis Section -->
                <div class="detailed-analysis">
                    <h3>Detailed Analysis</h3>
                    <div class="analysis-grid">
                        <div class="analysis-card">
                            <h4>Personality Traits</h4>
                            <p id="personalityTraits"></p>
                        </div>
                        <div class="analysis-card">
                            <h4>Career Potential</h4>
                            <p id="careerPotential"></p>
                        </div>
                        <div class="analysis-card">
                            <h4>Relationships</h4>
                            <p id="relationships"></p>
                        </div>
                        <div class="analysis-card">
                            <h4>Health & Wellness</h4>
                            <p id="healthWellness"></p>
                        </div>
                    </div>
                </div>

                <!-- Recommendations Section -->
                <div class="recommendations">
                    <h3>Personalized Recommendations</h3>
                    <div class="recommendations-list" id="recommendationsList">
                        <!-- Recommendations will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加弹出层HTML结构 -->
    <div id="popupOverlay" class="popup-overlay">
        <div class="popup-card">
            <button class="popup-close" onclick="closePopup()">×</button>
            <div class="popup-content">
                <div class="popup-character"></div>
                <div class="popup-title"></div>
                <div class="popup-description"></div>
                <div class="popup-element"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize year select (1900 to current year)
            const yearSelect = document.getElementById('birthYear');
            const currentYear = new Date().getFullYear();
            for (let year = 1900; year <= currentYear; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }

            // Initialize month select (1 to 12)
            const monthSelect = document.getElementById('birthMonth');
            for (let month = 1; month <= 12; month++) {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month;
                monthSelect.appendChild(option);
            }

            // Initialize hour select (子时 to 亥时)
            const hourSelect = document.getElementById('birthHour');
            const hours = [
                'Zi (23:00-1:00)', 'Chou (1:00-3:00)', 
                'Yin (3:00-5:00)', 'Mao (5:00-7:00)',
                'Chen (7:00-9:00)', 'Si (9:00-11:00)',
                'Wu (11:00-13:00)', 'Wei (13:00-15:00)',
                'Shen (15:00-17:00)', 'You (17:00-19:00)',
                'Xu (19:00-21:00)', 'Hai (21:00-23:00)'
            ];
            hours.forEach((hour, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = hour;
                hourSelect.appendChild(option);
            });

            // Update days when month/year changes
            yearSelect.addEventListener('change', updateDays);
            monthSelect.addEventListener('change', updateDays);
            updateDays();

            // Handle birth form submission
            document.getElementById('birthForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const year = parseInt(document.getElementById('birthYear').value);
                const month = parseInt(document.getElementById('birthMonth').value);
                const day = parseInt(document.getElementById('birthDay').value);
                const hour = parseInt(document.getElementById('birthHour').value);
                
                // Calculate BaZi
                const bazi = calculateBaZi(year, month, day, hour);
                
                // Store the result for later use
                window.baziResult = bazi;
                
                // 直接跳转到第二步
                showStep(2);
            });

            // Handle email form submission
            document.getElementById('emailForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const email = document.getElementById('email').value;
                const codeInputs = document.querySelectorAll('.verification-code input');
                const code = Array.from(codeInputs).map(input => input.value).join('');
                
                // Update alert messages
                if (!email) {
                    alert('Please enter your email address');
                    return;
                }
                if (!isValidEmail(email)) {
                    alert('Please enter a valid email address');
                    return;
                }

                // 验证码验证
                if (code === '1234') {
                    const bazi = window.baziResult;
                    if (bazi) {
                        // 先切换到结果页面
                        showStep(3);
                        // 然后更新结果
                        setTimeout(() => {
                            updateResultsTable(bazi);
                        }, 100);
                    } else {
                        alert('Error: Birth information not found. Please try again.');
                    }
                } else {
                    alert('Invalid verification code. Please try again.');
                }
            });

            // 添加发送验证码按钮的点击事件
            document.getElementById('sendCodeBtn').addEventListener('click', function() {
                const email = document.getElementById('email').value;
                
                if (!email) {
                    alert('Please enter your email address');
                    return;
                }
                if (!isValidEmail(email)) {
                    alert('Please enter a valid email address');
                    return;
                }

                // 禁用按钮并开始倒计时
                this.disabled = true;
                const resendTimer = document.getElementById('resendTimer');
                let countdown = 60;
                
                const timer = setInterval(() => {
                    resendTimer.textContent = `Resend in ${countdown}s`;
                    countdown--;
                    
                    if (countdown < 0) {
                        clearInterval(timer);
                        this.disabled = false;
                        resendTimer.textContent = '';
                    }
                }, 1000);
                
                // 发送验证码
                alert('Verification code sent to your email: 1234');
            });

            // 验证邮箱格式
            function isValidEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            }

            // Handle verification code inputs
            const codeInputs = document.querySelectorAll('.verification-code input');
            codeInputs.forEach((input, index) => {
                input.addEventListener('input', function(e) {
                    if (this.value.length === 1 && index < codeInputs.length - 1) {
                        codeInputs[index + 1].focus();
                    }
                });

                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Backspace' && !this.value && index > 0) {
                        codeInputs[index - 1].focus();
                    }
                });
            });
        });

        function updateDays() {
            const year = parseInt(document.getElementById('birthYear').value);
            const month = parseInt(document.getElementById('birthMonth').value);
            const daySelect = document.getElementById('birthDay');
            const daysInMonth = new Date(year, month, 0).getDate();

            daySelect.innerHTML = '<option value="">Select Day</option>';
            for (let day = 1; day <= daysInMonth; day++) {
                const option = document.createElement('option');
                option.value = day;
                option.textContent = day;
                daySelect.appendChild(option);
            }
        }

        function showStep(stepNumber) {
            // 隐藏所有步骤
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            
            // 显示目标步骤
            const targetStep = document.getElementById(`step${stepNumber}`);
            if (targetStep) {
                targetStep.classList.add('active');
            }
        }

        function calculateBaZi(year, month, day, hour) {
            // 天干
            const heavenlyStems = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
            // 地支
            const earthlyBranches = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
            // 生肖
            const zodiacAnimals = ['Rat', 'Ox', 'Tiger', 'Rabbit', 'Dragon', 'Snake', 'Horse', 'Goat', 'Monkey', 'Rooster', 'Dog', 'Pig'];
            
            // 计算年柱
            const yearStem = heavenlyStems[(year - 4) % 10];
            const yearBranch = earthlyBranches[(year - 4) % 12];
            const zodiacAnimal = zodiacAnimals[(year - 4) % 12];
            
            // 计算月柱
            const monthStem = heavenlyStems[(year * 2 + month) % 10];
            const monthBranch = earthlyBranches[(month - 1) % 12];
            
            // 计算日柱
            const dayStem = heavenlyStems[Math.floor((year * 5 + Math.floor(year / 4) + day) % 10)];
            const dayBranch = earthlyBranches[Math.floor((year * 5 + Math.floor(year / 4) + day) % 12)];
            
            // 计算时柱
            const hourStem = heavenlyStems[Math.floor((year * 2 + hour) % 10)];
            const hourBranch = earthlyBranches[hour % 12];
            
            return {
                year: { stem: yearStem, branch: yearBranch },
                month: { stem: monthStem, branch: monthBranch },
                day: { stem: dayStem, branch: dayBranch },
                hour: { stem: hourStem, branch: hourBranch },
                zodiacAnimal: zodiacAnimal,
                westernZodiac: calculateWesternZodiac(month, day)
            };
        }

        function calculateWesternZodiac(month, day) {
            const dates = [20, 19, 21, 20, 21, 21, 23, 23, 23, 23, 22, 22];
            const signs = ['Aquarius', 'Pisces', 'Aries', 'Taurus', 'Gemini', 'Cancer', 'Leo', 'Virgo', 'Libra', 'Scorpio', 'Sagittarius', 'Capricorn'];
            const index = day < dates[month - 1] ? (month - 2 + 12) % 12 : (month - 1) % 12;
            return signs[index];
        }

        function updateBaziChart(bazi) {
            try {
                const cells = {
                    'yearStem': {
                        char: bazi.year.stem,
                        title: 'Year Heavenly Stem',
                        description: 'Represents your relationship with the older generation and early life fortune.',
                        element: getElementForStem(bazi.year.stem)
                    },
                    'yearBranch': {
                        char: bazi.year.branch,
                        title: 'Year Earthly Branch',
                        description: 'Shows your family background and inherited traits.',
                        element: getElementForBranch(bazi.year.branch)
                    },
                    'monthStem': {
                        char: bazi.month.stem,
                        title: 'Month Heavenly Stem',
                        description: 'Indicates your learning abilities and career potential.',
                        element: getElementForStem(bazi.month.stem)
                    },
                    'monthBranch': {
                        char: bazi.month.branch,
                        title: 'Month Earthly Branch',
                        description: 'Reflects your work environment and career opportunities.',
                        element: getElementForBranch(bazi.month.branch)
                    },
                    'dayStem': {
                        char: bazi.day.stem,
                        title: 'Day Heavenly Stem',
                        description: 'Represents your core personality and personal characteristics.',
                        element: getElementForStem(bazi.day.stem)
                    },
                    'dayBranch': {
                        char: bazi.day.branch,
                        title: 'Day Earthly Branch',
                        description: 'Shows your social circle and interpersonal relationships.',
                        element: getElementForBranch(bazi.day.branch)
                    },
                    'hourStem': {
                        char: bazi.hour.stem,
                        title: 'Hour Heavenly Stem',
                        description: 'Indicates your thinking pattern and potential talents.',
                        element: getElementForStem(bazi.hour.stem)
                    },
                    'hourBranch': {
                        char: bazi.hour.branch,
                        title: 'Hour Earthly Branch',
                        description: 'Predicts your future development and late life fortune.',
                        element: getElementForBranch(bazi.hour.branch)
                    }
                };

                for (const [id, content] of Object.entries(cells)) {
                    const cell = document.getElementById(id);
                    if (cell) {
                        cell.textContent = content.char;
                        cell.onclick = () => showPopup(
                            content.char,
                            content.title,
                            content.description,
                            content.element
                        );
                    }
                }

                // 添加点击空白处关闭弹窗
                const popupOverlay = document.getElementById('popupOverlay');
                if (popupOverlay) {
                    popupOverlay.onclick = function(event) {
                        if (event.target === this) {
                            closePopup();
                        }
                    };
                }
            } catch (error) {
                console.error('Error updating BaZi chart:', error);
            }
        }

        function updateResultsTable(bazi) {
            try {
                // 更新八字图表
                updateBaziChart(bazi);

                // 更新基本信息
                const zodiacAnimalElement = document.getElementById('zodiacAnimal');
                const zodiacIconElement = document.getElementById('zodiacIcon');
                const zodiacElementElement = document.getElementById('zodiacElement');
                const westernZodiacElement = document.getElementById('westernZodiac');
                const zodiacSignIconElement = document.getElementById('zodiacSignIcon');
                const zodiacSignElementElement = document.getElementById('zodiacSignElement');

                if (!zodiacAnimalElement || !zodiacIconElement || !zodiacElementElement ||
                    !westernZodiacElement || !zodiacSignIconElement || !zodiacSignElementElement) {
                    console.error('One or more basic info elements not found');
                    return;
                }

                const zodiacIcons = {
                    'Rat': '🐭', 'Ox': '🐮', 'Tiger': '🐯', 'Rabbit': '🐰',
                    'Dragon': '🐲', 'Snake': '🐍', 'Horse': '🐴', 'Goat': '🐑',
                    'Monkey': '🐵', 'Rooster': '🐔', 'Dog': '🐶', 'Pig': '🐷'
                };
                
                const zodiacElements = {
                    'Rat': 'Water', 'Ox': 'Earth', 'Tiger': 'Wood', 'Rabbit': 'Wood',
                    'Dragon': 'Earth', 'Snake': 'Fire', 'Horse': 'Fire', 'Goat': 'Earth',
                    'Monkey': 'Metal', 'Rooster': 'Metal', 'Dog': 'Earth', 'Pig': 'Water'
                };
                
                const zodiacSignIcons = {
                    'Aquarius': '♒', 'Pisces': '♓', 'Aries': '♈', 'Taurus': '♉',
                    'Gemini': '♊', 'Cancer': '♋', 'Leo': '♌', 'Virgo': '♍',
                    'Libra': '♎', 'Scorpio': '♏', 'Sagittarius': '♐', 'Capricorn': '♑'
                };

                const zodiacSignElements = {
                    'Aquarius': 'Air', 'Pisces': 'Water', 'Aries': 'Fire', 'Taurus': 'Earth',
                    'Gemini': 'Air', 'Cancer': 'Water', 'Leo': 'Fire', 'Virgo': 'Earth',
                    'Libra': 'Air', 'Scorpio': 'Water', 'Sagittarius': 'Fire', 'Capricorn': 'Earth'
                };

                zodiacAnimalElement.textContent = bazi.zodiacAnimal;
                zodiacIconElement.textContent = zodiacIcons[bazi.zodiacAnimal];
                zodiacElementElement.textContent = `Element: ${zodiacElements[bazi.zodiacAnimal]}`;
                
                westernZodiacElement.textContent = bazi.westernZodiac;
                zodiacSignIconElement.textContent = zodiacSignIcons[bazi.westernZodiac];
                zodiacSignElementElement.textContent = `Element: ${zodiacSignElements[bazi.westernZodiac]}`;

                // 计算和更新五行
                const elements = calculateElements(bazi);
                const total = Object.values(elements).reduce((a, b) => a + b, 0);
                
                for (const [element, count] of Object.entries(elements)) {
                    const percentage = Math.round((count / total) * 100);
                    const percentageElement = document.getElementById(`${element}Percentage`);
                    if (percentageElement) {
                        percentageElement.textContent = `${percentage}%`;
                    }
                }

                // 生成详细分析
                generateDetailedAnalysis(bazi, elements);

            } catch (error) {
                console.error('Error updating results:', error);
            }
        }

        function calculateElements(bazi) {
            const elements = {
                wood: 0,
                fire: 0,
                earth: 0,
                metal: 0,
                water: 0
            };
            
            // 天干五行对应
            const stemElements = {
                '甲': 'Wood', '乙': 'Wood',
                '丙': 'Fire', '丁': 'Fire',
                '戊': 'Earth', '己': 'Earth',
                '庚': 'Metal', '辛': 'Metal',
                '壬': 'Water', '癸': 'Water'
            };
            
            // 地支五行对应
            const branchElements = {
                '子': 'Water', '丑': 'Earth',
                '寅': 'Wood', '卯': 'Wood',
                '辰': 'Earth', '巳': 'Fire',
                '午': 'Fire', '未': 'Earth',
                '申': 'Metal', '酉': 'Metal',
                '戌': 'Earth', '亥': 'Water'
            };
            
            // 计算天干五行
            elements[stemElements[bazi.year.stem]] += 1;
            elements[stemElements[bazi.month.stem]] += 1;
            elements[stemElements[bazi.day.stem]] += 1;
            elements[stemElements[bazi.hour.stem]] += 1;
            
            // 计算地支五行
            elements[branchElements[bazi.year.branch]] += 1;
            elements[branchElements[bazi.month.branch]] += 1;
            elements[branchElements[bazi.day.branch]] += 1;
            elements[branchElements[bazi.hour.branch]] += 1;
            
            return elements;
        }

        function generateDetailedAnalysis(bazi, elements) {
            // 性格特征
            const personalityTraits = generatePersonalityTraits(bazi, elements);
            document.getElementById('personalityTraits').textContent = personalityTraits;

            // 事业发展
            const careerPotential = generateCareerPotential(bazi, elements);
            document.getElementById('careerPotential').textContent = careerPotential;

            // 人际关系
            const relationships = generateRelationships(bazi, elements);
            document.getElementById('relationships').textContent = relationships;

            // 健康建议
            const healthWellness = generateHealthWellness(bazi, elements);
            document.getElementById('healthWellness').textContent = healthWellness;

            // 生成建议
            generateRecommendations(bazi, elements);
        }

        function generatePersonalityTraits(bazi, elements) {
            const traits = [];
            const strongestElement = Object.entries(elements)
                .sort(([,a], [,b]) => b - a)[0][0];

            const elementTraits = {
                wood: [
                    "Creative and innovative",
                    "Flexible and adaptable",
                    "Values fairness and justice"
                ],
                fire: [
                    "Enthusiastic and energetic",
                    "Natural leader",
                    "Decisive and quick to act"
                ],
                earth: [
                    "Practical and reliable",
                    "Patient and balanced",
                    "Responsible and committed"
                ],
                metal: [
                    "Precise and detail-oriented",
                    "Just and principled",
                    "Determined and focused"
                ],
                water: [
                    "Sharp-minded with strong intuition",
                    "Adaptable to change",
                    "Wise and profound thinker"
                ]
            };

            return elementTraits[strongestElement].join("；");
        }

        function generateCareerPotential(bazi, elements) {
            const careers = [];
            const strongestElement = Object.entries(elements)
                .sort(([,a], [,b]) => b - a)[0][0];

            const elementCareers = {
                wood: [
                    "Creative industries",
                    "Environmental protection",
                    "Education and training"
                ],
                fire: [
                    "Leadership and management",
                    "Marketing",
                    "Entertainment industry"
                ],
                earth: [
                    "Real estate",
                    "Agriculture",
                    "Healthcare"
                ],
                metal: [
                    "Finance and banking",
                    "Law and justice",
                    "Engineering"
                ],
                water: [
                    "Research and analysis",
                    "Psychology and counseling",
                    "Information technology"
                ]
            };

            return `Suitable career paths: ${elementCareers[strongestElement].join(", ")}. These fields can fully utilize your natural talents and potential.`;
        }

        function generateRelationships(bazi, elements) {
            const relationships = [];
            const strongestElement = Object.entries(elements)
                .sort(([,a], [,b]) => b - a)[0][0];

            const interpretation = generateInterpretation(elements);
            relationships.push(interpretation);

            return relationships.join(". ");
        }

        function generateInterpretation(elements) {
            const total = Object.values(elements).reduce((a, b) => a + b, 0);
            const percentages = {};
            
            for (const [element, count] of Object.entries(elements)) {
                percentages[element] = Math.round((count / total) * 100);
            }
            
            let interpretation = "Your BaZi chart shows ";
            
            const strongestElement = Object.entries(percentages)
                .sort(([,a], [,b]) => b - a)[0];
            
            const elementNames = {
                wood: 'Wood',
                fire: 'Fire',
                earth: 'Earth',
                metal: 'Metal',
                water: 'Water'
            };
            
            interpretation += `a strong presence of ${elementNames[strongestElement[0]]} element (${strongestElement[1]}%)`;
            
            const relationships = {
                wood: { generates: 'fire', controls: 'earth' },
                fire: { generates: 'earth', controls: 'metal' },
                earth: { generates: 'metal', controls: 'water' },
                metal: { generates: 'water', controls: 'wood' },
                water: { generates: 'wood', controls: 'fire' }
            };
            
            const supportingElement = relationships[strongestElement[0]].generates;
            const controlledElement = relationships[strongestElement[0]].controls;
            
            interpretation += `, suggesting ${getElementTraits(strongestElement[0])}. `;
            interpretation += `The ${elementNames[supportingElement]} element (${percentages[supportingElement]}%) supports your ${elementNames[strongestElement[0]]} energy, `;
            interpretation += `while the ${elementNames[controlledElement]} element (${percentages[controlledElement]}%) is controlled by it.`;
            
            return interpretation;
        }

        function getElementTraits(element) {
            const traits = {
                wood: "You are creative, growth-oriented, and flexible",
                fire: "You are passionate, have leadership qualities, and embrace change",
                earth: "You are practical, stable, and nurturing",
                metal: "You are precise, determined, and pursue justice",
                water: "You are wise, adaptable, and possess deep intuition"
            };
            return traits[element];
        }

        function generateHealthWellness(bazi, elements) {
            const health = [];
            const strongestElement = Object.entries(elements)
                .sort(([,a], [,b]) => b - a)[0][0];

            const elementHealth = {
                wood: [
                    "Pay attention to liver and eye health",
                    "Recommended: stretching exercises",
                    "Include green vegetables in diet"
                ],
                fire: [
                    "Monitor heart and circulation",
                    "Recommended: aerobic exercises",
                    "Maintain emotional balance"
                ],
                earth: [
                    "Focus on digestive health",
                    "Recommended: moderate exercise",
                    "Maintain balanced diet"
                ],
                metal: [
                    "Care for respiratory system",
                    "Practice breathing exercises",
                    "Maintain clean environment"
                ],
                water: [
                    "Monitor kidney and bladder health",
                    "Stay well hydrated",
                    "Recommended: swimming"
                ]
            };

            return elementHealth[strongestElement].join("；");
        }

        function generateRecommendations(bazi, elements) {
            const recommendationsList = document.getElementById('recommendationsList');
            if (!recommendationsList) {
                console.error('Recommendations list element not found');
                return;
            }
            recommendationsList.innerHTML = '';

            const strongestElement = Object.entries(elements)
                .sort(([,a], [,b]) => b - a)[0][0];

            const elementRecommendations = {
                wood: [
                    { icon: '🌱', text: 'Engage in creative activities and projects' },
                    { icon: '🌳', text: 'Spend time in nature' },
                    { icon: '📚', text: 'Continue learning and growing' }
                ],
                fire: [
                    { icon: '🔥', text: 'Take leadership roles' },
                    { icon: '🗣️', text: 'Improve public speaking skills' },
                    { icon: '🎭', text: 'Participate in social activities' }
                ],
                earth: [
                    { icon: '🏡', text: 'Establish stable routines' },
                    { icon: '🌍', text: 'Develop gardening interests' },
                    { icon: '🤝', text: 'Build long-term relationships' }
                ],
                metal: [
                    { icon: '⚖️', text: 'Cultivate self-discipline' },
                    { icon: '✨', text: 'Pursue quality in life' },
                    { icon: '🎯', text: 'Set clear goals' }
                ],
                water: [
                    { icon: '🌊', text: 'Stay flexible and adaptable' },
                    { icon: '🧘', text: 'Practice meditation' },
                    { icon: '🔍', text: 'Explore philosophical thinking' }
                ]
            };

            elementRecommendations[strongestElement].forEach(rec => {
                const item = document.createElement('div');
                item.className = 'recommendation-item';
                item.innerHTML = `
                    <div class="recommendation-icon">${rec.icon}</div>
                    <div class="recommendation-text">${rec.text}</div>
                `;
                recommendationsList.appendChild(item);
            });
        }

        // 添加弹出框相关函数
        function showPopup(character, title, description, element) {
            const overlay = document.getElementById('popupOverlay');
            const content = overlay.querySelector('.popup-content');
            
            content.querySelector('.popup-character').textContent = character;
            content.querySelector('.popup-title').textContent = title;
            content.querySelector('.popup-description').textContent = description;
            content.querySelector('.popup-element').textContent = `Element: ${element}`;
            
            overlay.classList.add('active');
        }

        function closePopup() {
            document.getElementById('popupOverlay').classList.remove('active');
        }

        // 添加获取五行属性的辅助函数
        function getElementForStem(stem) {
            const stemElements = {
                '甲': 'Wood', '乙': 'Wood',
                '丙': 'Fire', '丁': 'Fire',
                '戊': 'Earth', '己': 'Earth',
                '庚': 'Metal', '辛': 'Metal',
                '壬': 'Water', '癸': 'Water'
            };
            return stemElements[stem] || 'Unknown';
        }

        function getElementForBranch(branch) {
            const branchElements = {
                '子': 'Water', '丑': 'Earth',
                '寅': 'Wood', '卯': 'Wood',
                '辰': 'Earth', '巳': 'Fire',
                '午': 'Fire', '未': 'Earth',
                '申': 'Metal', '酉': 'Metal',
                '戌': 'Earth', '亥': 'Water'
            };
            return branchElements[branch] || 'Unknown';
        }
    </script>
</body>
</html> 